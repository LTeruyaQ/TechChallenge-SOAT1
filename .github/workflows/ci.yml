name: CI

on:
  push:
    branches: [ "feature/*" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Restaurar dependências
        run: dotnet restore MecanicaOS.sln

      - name: Compilar o projeto
        run: dotnet build MecanicaOS.sln --no-restore

      - name: Executar testes unitários
        run: |
          chmod +x .github/scripts/check_test_success.sh
          .github/scripts/check_test_success.sh

      - name: Construir imagem Docker para validação
        run: docker build . --file Dockerfile --tag mecanica-os-api:latest

  create-pr:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Criar Pull Request (se não existir um aberto)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          OPEN_PR_COUNT=$(gh pr list --state open --head ${{ github.ref_name }} --json number | jq 'length')
          if [ "$OPEN_PR_COUNT" -eq "0" ]; then
            echo "Nenhum Pull Request aberto encontrado para esta branch. Criando um novo."
            gh pr create \
              --base Main \
              --title "PR da feature: ${{ github.ref_name }}" \
              --body "Este Pull Request foi gerado automaticamente pela nossa pipeline de CI. Por favor, revise as alterações."
          else
            echo "Um Pull Request aberto já existe para esta branch. Nenhuma ação será tomada."
          fi
